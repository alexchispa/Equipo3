#!/bin/bash

# Definir variables
nombre_vpc="pruebas"
cidr_block_vpc="10.0.0.0/16"

# Crear VPC
vpc_id=$(aws ec2 create-vpc --cidr-block $cidr_block_vpc --query 'Vpc.VpcId' --output text)
echo "VPC creada con ID: $vpc_id"

# Habilitar la asignación automática de direcciones IP
aws ec2 modify-vpc-attribute --vpc-id $vpc_id --enable-dns-support "{\"Value\":true}"
aws ec2 modify-vpc-attribute --vpc-id $vpc_id --enable-dns-hostnames "{\"Value\":true}"

# Crear subredes públicas
cidr_block_pub1="10.0.1.0/24"
cidr_block_pub2="10.0.2.0/24"

subnet_pub1_id=$(aws ec2 create-subnet --vpc-id $vpc_id --cidr-block $cidr_block_pub1 --availability-zone us-east-1a --query 'Subnet.SubnetId' --output text)
subnet_pub2_id=$(aws ec2 create-subnet --vpc-id $vpc_id --cidr-block $cidr_block_pub2 --availability-zone us-east-1b --query 'Subnet.SubnetId' --output text)

echo "Subredes públicas creadas con IDs: $subnet_pub1_id (publica11) y $subnet_pub2_id (publica12)"

# Crear subredes privadas
cidr_block_priv1="10.0.3.0/24"
cidr_block_priv2="10.0.4.0/24"

subnet_priv1_id=$(aws ec2 create-subnet --vpc-id $vpc_id --cidr-block $cidr_block_priv1 --availability-zone us-east-1a --query 'Subnet.SubnetId' --output text)
subnet_priv2_id=$(aws ec2 create-subnet --vpc-id $vpc_id --cidr-block $cidr_block_priv2 --availability-zone us-east-1b --query 'Subnet.SubnetId' --output text)

echo "Subredes privadas creadas con IDs: $subnet_priv1_id (privada11) y $subnet_priv2_id (privada12)"

# Crear tabla de enrutamiento pública
route_table_pub_id=$(aws ec2 create-route-table --vpc-id $vpc_id --query 'RouteTable.RouteTableId' --output text)
echo "Tabla de enrutamiento pública creada con ID: $route_table_pub_id"

# Asociar tabla de enrutamiento pública con subredes públicas
aws ec2 associate-route-table --subnet-id $subnet_pub1_id --route-table-id $route_table_pub_id
aws ec2 associate-route-table --subnet-id $subnet_pub2_id --route-table-id $route_table_pub_id

# Crear gateway de internet
internet_gateway_id=$(aws ec2 create-internet-gateway --query 'InternetGateway.InternetGatewayId' --output text)
echo "Gateway de internet creado con ID: $internet_gateway_id"

# Adjuntar gateway de internet a la VPC
aws ec2 attach-internet-gateway --vpc-id $vpc_id --internet-gateway-id $internet_gateway_id

# Añadir ruta pública a la tabla de enrutamiento
aws ec2 create-route --route-table-id $route_table_pub_id --destination-cidr-block 0.0.0.0/0 --gateway-id $internet_gateway_id

# Crear tabla de enrutamiento privada
route_table_priv_id=$(aws ec2 create-route-table --vpc-id $vpc_id --query 'RouteTable.RouteTableId' --output text)
echo "Tabla de enrutamiento privada creada con ID: $route_table_priv_id"

# Asociar tabla de enrutamiento privada con subredes privadas
aws ec2 associate-route-table --subnet-id $subnet_priv1_id --route-table-id $route_table_priv_id
aws ec2 associate-route-table --subnet-id $subnet_priv2_id --route-table-id $route_table_priv_id

# Imprimir información final
echo "VPC con subredes y tablas de enrutamiento creadas exitosamente."
