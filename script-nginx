sudo apt update

sudo apt-get install -y curl wget

#sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/pruebas-script.duckdns.org.key -out /etc/ssl/certs/pruebas-script.crt

echo "[req]
prompt = no
distinguished_name = dn
[dn]
C = ES
ST = Cantabria
L = Santander
O = educantabria
OU =
CN = script-pruebas.duckdns.org
emailAddress = ubuntu
" | sudo tee /etc/ssl/openssl.cnf

# Crear certificado autofirmado
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/pruebas-script.duckdns.org.key \
  -out /etc/ssl/certs/pruebas-script.crt \
  -config /etc/ssl/openssl.cnf

sudo mkdir duckdns

cd ./duckdns

echo 'url="https://www.duckdns.org/update?domains=3team&token=61d376ed-dfe4-4da0-b6ee-31e29bcf59ff&ip=" | curl -k -o ~/duckdns/duck.log -K â€“' | sudo tee ./duck.sh

sudo chmod 700 duck.sh

echo -e "1\n*/5 * * * * ~/duckdns/duck.sh >/dev/null 2>&1" | VISUAL=ed sudo crontab -

sudo apt update

sudo apt install nginx -y

echo 'server {
    if ($host = nginxequipo3.duckdns.org) {
        return 301 https://$host$request_uri;
    } # manejado por Certbot
    
    listen 80;
    server_name example.com;
    return 301 https://$host$request_uri;
    }

server {
listen 443 ssl;
server_name nginxequipo3.duckdns.org
    # ssl_certificate /etc/letsencrypt/live/nginxequipo3.duckdns.org/fullchain.pem; # manejado por Certbot
    # ssl_certificate_key /etc/letsencrypt/live/nginxequipo3.duckdns.org/privkey.pem; # manejado por Certbot

location /_mtrix {
proxy_pass http://10.13.2.247:8008;
        
proxy_set_header X-Forwarded-For $remote_addr;
client_max_body_size 10M;
}
    
}

server {
listen 8443 ssl;
server_name nginxequipor3.duckdns.org;

# ssl_certificate /etc/letsencrypt/live/nginxequipo3.duckdns.org/fullchain.pem; # manejado por Certbot
# ssl_certificate_key /etc/letsencrypt/live/nginxequipo3.duckdns.org/privkey.pem; # manejado por Certbot
    
location /_mtrix {
proxy_pass http://10.13.2.247:8008;
        
proxy_set_header X-Forwarded-For $remote_addr;
client_max_body_size 10M;
}
}' | sudo tee /etc/nginx/sites-available/nginxequipo3 

sudo ln -s /etc/nginx/sites-available/nginxequipo3 /etc/nginx/sites-enabled/
sudo nginx -t

sudo systemctl restart nginx
sudo systemctl status nginx

sudo apt update

sudo snap install --classic certbot

sudo ln -s /snap/bin/certbot /usr/bin/certbot

sudo certbot --nginx -d pruebas-script.dickdns.org
