sudo apt update

sudo apt-get install -y curl wget

echo "[req]
prompt = no
distinguished_name = dn
[dn]
C = ES
ST = Cantabria
L = Santander
O = educantabria
OU =
CN = script-pruebas.duckdns.org
emailAddress = ubuntu
" | sudo tee /etc/ssl/openssl.cnf

# Crear certificado autofirmado
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/pruebas-script.duckdns.org.key \
  -out /etc/ssl/certs/pruebas-script.crt \
  -subj "/C=ES/ST=Cantabria/L=Santander/O=educantabria/CN=script-pruebas.duckdns.org/emailAddress=ubuntu@gmail.com"

mkdir duckdns

cd ./duckdns

echo 'echo url="https://www.duckdns.org/update?domains=pruebas-script&token=0ab437ea-0827-4075-a780-cc56d2976306&ip=" | curl -k -o ~/duckdns/duck.log -K -' |  tee ./duck.sh

./duck.sh

chmod 700 duck.sh

(crontab -l ; echo "*/5 * * * * ~/duckdns/duck.sh >/dev/null 2>&1") | crontab -

sudo apt update

sudo apt install nginx -y

echo 'server {
    if ($host = pruebas-script.duckdns.org) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = nginxequipo3.duckdns.org) {
        return 301 https://$host$request_uri;
    } # manejado por Certbot

    listen 80;
    server_name pruebas-script.duckdns.org;
    return 301 https://$host$request_uri;


}

server {
listen 443 ssl;
server_name pruebas-script.duckdns.org;
    ssl_certificate /etc/ssl/certs/pruebas-script.crt;
 # manejado por Certbot
    ssl_certificate_key /etc/ssl/private/pruebas-script.duckdns.org.key; # manejado por Certbot

location /_mtrix {
proxy_pass http://10.13.2.247:8008;

proxy_set_header X-Forwarded-For $remote_addr;
client_max_body_size 10M;
}


}

server {
listen 8443 ssl;
server_name pruebas-script.duckdns.org;

ssl_certificate /etc/ssl/certs/pruebas-script.crt; # manejado por Certbot
ssl_certificate_key /etc/ssl/private/pruebas-script.duckdns.org.key; # mane>

location /_mtrix {
proxy_pass http://10.13.2.247:8008;

proxy_set_header X-Forwarded-For $remote_addr;
client_max_body_size 10M;
}
}' | sudo tee /etc/nginx/sites-available/nginxequipo3 

sudo ln -s /etc/nginx/sites-available/nginxequipo3 /etc/nginx/sites-enabled/
sudo nginx -t

sudo systemctl restart nginx
sudo systemctl status nginx

sudo apt update

sudo snap install --classic certbot

sudo ln -s /snap/bin/certbot /usr/bin/certbot

sudo certbot --nginx -d pruebas-script.dickdns.org
